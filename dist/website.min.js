/**
 * whatbrowser.ru, version 0.1.0
 *
 * whatbrowser.ru is freely distributable under the terms of MIT-style license
 * For details, see http://whatbrowser.ru
 */
(function(window,$,UAParser,swfobject,deployJava){"use strict";var navigator=window.navigator,document=window.document;function has_cookies(){if(navigator.cookieEnabled){return true}document.cookie="cookietest=1";var ret=document.cookie.indexOf("cookietest=")!==-1;document.cookie="cookietest=1; expires=Thu, 01-Jan-1970 00:00:01 GMT";return ret}function has_flash(){try{var fo=window.ActiveXObject&&new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash")||null;if(fo){return true}}catch(e){if(navigator.mimeTypes&&navigator.mimeTypes["application/x-shockwave-flash"]!==undefined&&navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin){return true}}return false}function resolution_to_str(width,height){return width+" × "+height+" px"}function load_property(whatbrowser,property_name,load_func,source){whatbrowser[property_name]=source?source[property_name]:load_func()}function browser_size(whatbrowser,source){var self=whatbrowser;load_property(whatbrowser,"browser_size",function(){return{height:$(window).height(),width:$(window).width()}},source);self.browser_size.toString=function(){return resolution_to_str(self.browser_size.width,self.browser_size.height)}}function cookies(whatbrowser,source){load_property(whatbrowser,"cookies",function(){return has_cookies()},source)}function flash(whatbrowser,source){var self=whatbrowser;load_property(whatbrowser,"flash",function(){return{enabled:has_flash(),version:swfobject&&swfobject.getFlashPlayerVersion()}},source);self.flash.toString=function(){if(self.flash.enabled&&self.flash.version){return self.flash.version.major+"."+self.flash.version.minor+"."+self.flash.version.release}else{return self.flash.enabled?"да":"нет"}}}function javafn(whatbrowser,source){var self=whatbrowser;load_property(whatbrowser,"java",function(){return{enabled:navigator.javaEnabled&&navigator.javaEnabled(),version:deployJava&&deployJava.getJREs().shift()}},source);self.java.toString=function(){return self.java.enabled?self.java.version||"да":"нет"}}function language(whatbrowser,source){load_property(whatbrowser,"language",function(){return navigator.language||navigator.userLanguage},source)}function online(whatbrowser,source){load_property(whatbrowser,"online",function(){return navigator.onLine},source)}function screenfn(whatbrowser,source){var self=whatbrowser;load_property(whatbrowser,"screen",function(){return window.screen&&{color_depth:window.screen.colorDepth,pixel_ratio:window.devicePixelRatio,height:window.screen.height,width:window.screen.width}},source);self.screen.toString=function(){var scrn=self.screen,str=scrn&&resolution_to_str(scrn.width,scrn.height)+", "+scrn.color_depth+" bit"||"";str+=scrn.pixel_ratio&&scrn.pixel_ratio>1&&" (retina "+resolution_to_str(scrn.width*scrn.pixel_ratio,scrn.height*scrn.pixel_ratio)+")"||"";return str}}function ua(whatbrowser,source){var self=whatbrowser;if(!UAParser){self.ua={ua:navigator.userAgent};return}load_property(whatbrowser,"ua",function(){return(new UAParser).getResult()},source);self.ua.toString=function(){return self.ua.ua};self.ua.browser.toString=function(){var browser=self.ua.browser,str=browser.name||"";str+=browser.major&&" "+browser.major||"";str+=browser.version&&" ("+browser.version+")"||"";return str};self.ua.device.toString=function(){var device=self.ua.device,str=device.vendor||"";str+=device.model&&" "+device.model||"";str+=device.type&&" ("+device.type+")"||"";return str};self.ua.engine.toString=function(){var engine=self.ua.engine,str=engine.name||"";str+=engine.version&&" "+engine.version||"";return str};self.ua.os.toString=function(){var os=self.ua.os,str=os.name||"";str+=os.version&&" "+os.version||"";return str}}function fill_geo(whatbrowser,geo){var self=whatbrowser;self.geo=geo;if(self.geo&&self.geo.position){self.geo.position.toString=function(){var position=self.geo.position;return position.latitude?position.latitude+", "+position.longitude:""}}if(self.geo&&self.geo.address){self.geo.address.toString=function(){var address=self.geo.address,str=address.country||"";str+=address.region&&", "+address.region||"";str+=address.city&&", "+address.city||"";return str}}}function geolocate(whatbrowser){var promise=$.Deferred(),received_answer=false;$.getJSON("//freegeoip.net/json/?callback=?",{timeout:500}).done(function(data){fill_geo(whatbrowser,{ip:data.ip,position:{latitude:data.latitude,longitude:data.longitude},address:{country:data.country_name,region:data.region_name,city:data.city}});promise.resolve(whatbrowser)}).fail(function(){promise.resolve(whatbrowser)}).always(function(){received_answer=true});window.setTimeout(function(){if(!received_answer){promise.resolve(whatbrowser)}},800);return promise}function WhatBrowser(source){var self=this;browser_size(self,source);cookies(self,source);flash(self,source);javafn(self,source);language(self,source);online(self,source);screenfn(self,source);ua(self,source);if(source){fill_geo(self,source.geo)}}WhatBrowser.create=function(options){var whatbrowser=new WhatBrowser,promise=$.Deferred();options=options||{};if(options.geo){geolocate(whatbrowser).always(function(whatbrowserWithGeo){promise.resolve(whatbrowserWithGeo)})}else{promise.resolve(whatbrowser)}return promise};window.WhatBrowser=WhatBrowser;return WhatBrowser})(window,window.jQuery,window.UAParser,window.swfobject,window.deployJava);(function(JSON,LZString){"use strict";window.Hashcode={parse:JSON.parse,serialize:JSON.stringify,compress_base64:LZString.compressToBase64,decompress_base64:LZString.decompressFromBase64};return window.Hashcode})(window.JSON,window.LZString);(function($,Cookies,Hashcode,WhatBrowser){"use strict";var PARSE_BASE_URL="https://api.parse.com/1/classes/WhatBrowser",PARSE_HEADERS={"X-Parse-Application-Id":"WxMn71WOwf2RM6s6vYR57Th1rsfRplumcDDaWQxF","X-Parse-REST-API-Key":"EA4xA8UNhbUK5eMyHepEJnUWDyCzoMZxr0t1HOmp"},SAVE_TIMEOUT=1e3,LOAD_TIMEOUT=2e3;function log(message){return message}function get_id(){function get_id_url(){var hash=window.location.hash;if(hash&&hash.substr(0,2)==="#!"){return{value:hash.substr(2),local:false}}return null}function get_id_cookies(){if(Cookies.enabled){var id=Cookies.get("whatbrowser");if(id){return{value:id,local:true}}}return null}return get_id_url()||get_id_cookies()||{value:null,local:true}}function get_long_link(whatbrowser){try{var whatbrowser_str=Hashcode.serialize(whatbrowser),hash=Hashcode.compress_base64(whatbrowser_str);return{hash:hash,full:window.location.origin+"/#!"+hash}}catch(e){return null}}function get_short_link(whatbrowser){return{hash:whatbrowser.id,full:window.location.origin+"/#!"+whatbrowser.id}}function create(id){var loader=WhatBrowser.create(),promise=$.Deferred();loader.done(function(whatbrowser){if(id){whatbrowser.id=id;whatbrowser.link=get_short_link(whatbrowser)}else{whatbrowser.link=get_long_link(whatbrowser)}promise.resolve(whatbrowser)});return promise}function create_and_save(){var loader=WhatBrowser.create(),promise=$.Deferred();loader.done(function(whatbrowser){log("Saving new info");$.ajax(PARSE_BASE_URL,{contentType:"application/json",data:JSON.stringify(whatbrowser),dataType:"json",headers:PARSE_HEADERS,timeout:SAVE_TIMEOUT,type:"POST"}).done(function(response){log("Saved info");whatbrowser.id=response.objectId;whatbrowser.link=get_short_link(whatbrowser);if(Cookies.enabled){Cookies.set("whatbrowser",whatbrowser.id,{expires:28800})}promise.resolve(whatbrowser)}).fail(function(xhr,status,error){log("Failed to save info, status "+status+", error "+error);whatbrowser.link=get_long_link(whatbrowser);promise.reject(whatbrowser,error)})});return promise}function update(id,whatbrowser){var promise=$.Deferred(),link=whatbrowser.link;log("Updating info");delete whatbrowser.link;$.ajax(PARSE_BASE_URL+"/"+id,{contentType:"application/json",data:JSON.stringify(whatbrowser),dataType:"json",headers:PARSE_HEADERS,timeout:SAVE_TIMEOUT,type:"PUT"}).done(function(){log("Updated info");whatbrowser.link=link;promise.resolve(whatbrowser)}).fail(function(xhr,status,error){log("Failed to update info, status "+status+", error "+error);whatbrowser.link=link;promise.reject(whatbrowser,error)});return promise}function load_from_str(id){var whatbrowser,whatbrowser_str,promise=$.Deferred();log("Loading info from string: "+id);try{whatbrowser_str=Hashcode.decompress_base64(id);whatbrowser=new WhatBrowser(Hashcode.parse(whatbrowser_str));whatbrowser.link=get_long_link(whatbrowser);whatbrowser.id=whatbrowser.link.hash.substr(0,3)+whatbrowser.link.hash.substr(-5,3);log("Loaded info");promise.resolve(whatbrowser)}catch(e){log("Failed to load info: "+e);promise.reject(whatbrowser,"Failed to load info from string:"+id)}return promise}function load_from_db(id){var promise=$.Deferred();log("Loading info #"+id);$.ajax(PARSE_BASE_URL+"/"+id,{contentType:"application/json",dataType:"json",headers:PARSE_HEADERS,timeout:LOAD_TIMEOUT,type:"GET"}).done(function(info){log("Loaded info #"+id);var whatbrowser=new WhatBrowser(info);whatbrowser.id=id;whatbrowser.link=get_short_link(whatbrowser);promise.resolve(whatbrowser)}).fail(function(xhr,status,error){log("Failed to load info #"+id+", status "+status+", error "+error);promise.reject(error)});return promise}function load(id){if(id.length===10){return load_from_db(id)}else{return load_from_str(id)}}window.WhatBrowserManager={get_id:get_id,create:create,create_and_save:create_and_save,update:update,load:load};return window.WhatBrowserManager})(window.jQuery,window.Cookies,window.Hashcode,window.WhatBrowser);(function($,ZeroClipboard,WhatBrowserManager){"use strict";function render_property(name,value){var str_value=value&&value.toString&&value.toString()||""+value;if(str_value==="undefined"||!str_value){return""}return"<tr>"+"<th>"+name+"</th>"+"<td>"+str_value+"</td>"+"</tr>"}function render_info(whatbrowser){var properties="";properties+=render_property("Куки",whatbrowser.cookies?"да":"нет");properties+=render_property("Флеш",whatbrowser.flash);properties+=render_property("Джава",whatbrowser.java);properties+=render_property("Язык",whatbrowser.language);properties+=render_property("Страница",whatbrowser.browser_size);properties+=render_property("Экран",whatbrowser.screen);properties+=render_property("Браузер",whatbrowser.ua&&whatbrowser.ua.browser);properties+=render_property("Движок",whatbrowser.ua&&whatbrowser.ua.engine);properties+=render_property("ОС",whatbrowser.ua&&whatbrowser.ua.os);properties+=render_property("Устройство",whatbrowser.ua&&whatbrowser.ua.device);properties+=render_property("Юзер-агент",whatbrowser.ua);properties+=render_property("IP-адрес",whatbrowser.geo&&whatbrowser.geo.ip);properties+=render_property("Местоположение",whatbrowser.geo&&whatbrowser.geo.address);return properties}function render_header(whatbrowser,own){var header_msg="";if(!own){header_msg="Сохраненный браузер: "+'<a href="'+whatbrowser.link.full+'">'+whatbrowser.ua.browser.name+" "+whatbrowser.ua.browser.major+" </a>"}else if(whatbrowser.ua.browser.name){header_msg="У вас "+whatbrowser.ua.browser.name+" "+whatbrowser.ua.browser.major;header_msg+=whatbrowser.ua.os.name?" на "+whatbrowser.ua.os.name:""}else{header_msg="У вас неизвестный науке браузер :-["}return header_msg}function show_links(whatbrowser){if(whatbrowser.link&&ZeroClipboard&&whatbrowser.flash&&whatbrowser.flash.enabled){$("#copy-value").val(whatbrowser.link.full)}else if(whatbrowser.link){$("#info-link-copy").hide();$("#mail-value").val(whatbrowser.link.full);$("#info-link-mail").find("a").attr("href","mailto:?subject="+encodeURIComponent("Информация о моем браузере")+"&body="+encodeURIComponent(whatbrowser.link.full));$("#info-link-mail").show();if(window.history&&window.history.replaceState){window.history.replaceState(whatbrowser.link,"","#!"+whatbrowser.link.hash)}}else{$("#info-link").hide();$("#info-show").show()}}function show_info(whatbrowser,own){var $details=$("#details-table").children("tbody"),header=render_header(whatbrowser,own);$details.html(render_info(whatbrowser));if(own){$("#header-msg").html(header);show_links(whatbrowser)}else{$("#details-msg").html(header);$("#header").hide()}$("#message").hide();$("#result").fadeIn()}function init_clipboard($button){var clipboard=new ZeroClipboard($button.get(0));clipboard.on("aftercopy",function(e){var $btn=$(e.target),$text=$btn.prev(),$status=$btn.next();$text.focus().select();$status.text("Скопировано!");window.setTimeout(function(){$status.text("")},500)})}function show_external(id){WhatBrowserManager.load(id).done(function(whatbrowser){show_info(whatbrowser,false)}).fail(function(){$("#message").find("h2").text("По этой ссылке ничего нет :-[")})}function show_local(id){if(id){WhatBrowserManager.create(id).done(function(whatbrowser){show_info(whatbrowser,true);WhatBrowserManager.update(id,whatbrowser)})}else{WhatBrowserManager.create_and_save().done(function(whatbrowser){show_info(whatbrowser,true)}).fail(function(whatbrowser){show_info(whatbrowser,true)})}}function get_origin(){return window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")}function render(){var id=WhatBrowserManager.get_id();if(id.local){show_local(id.value)}else{show_external(id.value)}}function init_ui(){window.location.origin=window.location.origin||get_origin();$(window).on("hashchange",render);$(".link-text").click(function(){if(this.setSelectionRange){this.setSelectionRange(0,9999)}else{$(this).select()}});if(ZeroClipboard){ZeroClipboard.config({hoverClass:"zero-hover",activeClass:"zero-active"});init_clipboard($("#info-link").find("button"));init_clipboard($("#info-copy").find("button"))}}$(function(){init_ui();render()})})(window.jQuery,window.ZeroClipboard,window.WhatBrowserManager);