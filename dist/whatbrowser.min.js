/**
 * whatbrowser.ru, version 0.1.0
 *
 * whatbrowser.ru is freely distributable under the terms of MIT-style license
 * For details, see http://whatbrowser.ru
 */
(function(window,$,UAParser,swfobject,deployJava){"use strict";var navigator=window.navigator,document=window.document;function has_cookies(){if(navigator.cookieEnabled){return true}document.cookie="cookietest=1";var ret=document.cookie.indexOf("cookietest=")!==-1;document.cookie="cookietest=1; expires=Thu, 01-Jan-1970 00:00:01 GMT";return ret}function has_flash(){try{var fo=window.ActiveXObject&&new window.ActiveXObject("ShockwaveFlash.ShockwaveFlash")||null;if(fo){return true}}catch(e){if(navigator.mimeTypes&&navigator.mimeTypes["application/x-shockwave-flash"]!==undefined&&navigator.mimeTypes["application/x-shockwave-flash"].enabledPlugin){return true}}return false}function resolution_to_str(width,height){return width+" × "+height+" px"}function load_property(whatbrowser,property_name,load_func,source){whatbrowser[property_name]=source?source[property_name]:load_func()}function browser_size(whatbrowser,source){var self=whatbrowser;load_property(whatbrowser,"browser_size",function(){return{height:$(window).height(),width:$(window).width()}},source);self.browser_size.toString=function(){return resolution_to_str(self.browser_size.width,self.browser_size.height)}}function cookies(whatbrowser,source){load_property(whatbrowser,"cookies",function(){return has_cookies()},source)}function flash(whatbrowser,source){var self=whatbrowser;load_property(whatbrowser,"flash",function(){return{enabled:has_flash(),version:swfobject&&swfobject.getFlashPlayerVersion()}},source);self.flash.toString=function(){if(self.flash.enabled&&self.flash.version){return self.flash.version.major+"."+self.flash.version.minor+"."+self.flash.version.release}else{return self.flash.enabled?"да":"нет"}}}function javafn(whatbrowser,source){var self=whatbrowser;load_property(whatbrowser,"java",function(){return{enabled:navigator.javaEnabled&&navigator.javaEnabled(),version:deployJava&&deployJava.getJREs().shift()}},source);self.java.toString=function(){return self.java.enabled?self.java.version||"да":"нет"}}function language(whatbrowser,source){load_property(whatbrowser,"language",function(){return navigator.language||navigator.userLanguage},source)}function online(whatbrowser,source){load_property(whatbrowser,"online",function(){return navigator.onLine},source)}function screenfn(whatbrowser,source){var self=whatbrowser;load_property(whatbrowser,"screen",function(){return window.screen&&{color_depth:window.screen.colorDepth,pixel_ratio:window.devicePixelRatio,height:window.screen.height,width:window.screen.width}},source);self.screen.toString=function(){var scrn=self.screen,str=scrn&&resolution_to_str(scrn.width,scrn.height)+", "+scrn.color_depth+" bit"||"";str+=scrn.pixel_ratio&&scrn.pixel_ratio>1&&" (retina "+resolution_to_str(scrn.width*scrn.pixel_ratio,scrn.height*scrn.pixel_ratio)+")"||"";return str}}function ua(whatbrowser,source){var self=whatbrowser;if(!UAParser){self.ua={ua:navigator.userAgent};return}load_property(whatbrowser,"ua",function(){return(new UAParser).getResult()},source);self.ua.toString=function(){return self.ua.ua};self.ua.browser.toString=function(){var browser=self.ua.browser,str=browser.name||"";str+=browser.major&&" "+browser.major||"";str+=browser.version&&" ("+browser.version+")"||"";return str};self.ua.device.toString=function(){var device=self.ua.device,str=device.vendor||"";str+=device.model&&" "+device.model||"";str+=device.type&&" ("+device.type+")"||"";return str};self.ua.engine.toString=function(){var engine=self.ua.engine,str=engine.name||"";str+=engine.version&&" "+engine.version||"";return str};self.ua.os.toString=function(){var os=self.ua.os,str=os.name||"";str+=os.version&&" "+os.version||"";return str}}function fill_geo(whatbrowser,geo){var self=whatbrowser;self.geo=geo;if(self.geo&&self.geo.position){self.geo.position.toString=function(){var position=self.geo.position;return position.latitude?position.latitude+", "+position.longitude:""}}if(self.geo&&self.geo.address){self.geo.address.toString=function(){var address=self.geo.address,str=address.country||"";str+=address.region&&", "+address.region||"";str+=address.city&&", "+address.city||"";return str}}}function geolocate(whatbrowser){var promise=$.Deferred(),received_answer=false;$.getJSON("//freegeoip.net/json/?callback=?",{timeout:500}).done(function(data){fill_geo(whatbrowser,{ip:data.ip,position:{latitude:data.latitude,longitude:data.longitude},address:{country:data.country_name,region:data.region_name,city:data.city}});promise.resolve(whatbrowser)}).fail(function(){promise.resolve(whatbrowser)}).always(function(){received_answer=true});window.setTimeout(function(){if(!received_answer){promise.resolve(whatbrowser)}},800);return promise}function WhatBrowser(source){var self=this;browser_size(self,source);cookies(self,source);flash(self,source);javafn(self,source);language(self,source);online(self,source);screenfn(self,source);ua(self,source);if(source){fill_geo(self,source.geo)}}WhatBrowser.create=function(options){var whatbrowser=new WhatBrowser,promise=$.Deferred();options=options||{};if(options.geo){geolocate(whatbrowser).always(function(whatbrowserWithGeo){promise.resolve(whatbrowserWithGeo)})}else{promise.resolve(whatbrowser)}return promise};window.WhatBrowser=WhatBrowser;return WhatBrowser})(window,window.jQuery,window.UAParser,window.swfobject,window.deployJava);